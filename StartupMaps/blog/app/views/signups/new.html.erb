
<script src="//maps.google.com/maps/api/js?v=3.13&amp;sensor=false&amp;libraries=geometry" type="text/javascript"></script>
<script src='//google-maps-utility-library-v3.googlecode.com/svn/tags/markerclustererplus/2.0.14/src/markerclusterer_packed.js' type='text/javascript'></script>  

<div style='width: 800px;'>
  <div id="multi_markers" style='width: 600px; height: 600px;'></div>
</div> 

<script type = "text/javascript">

var handler = Gmaps.build('Google');
handler.buildMap({ provider: { }, internal: {id: 'multi_markers'}}, function(){
  msrkers = handler.addMarkers(<%=raw @hash.to_json %>);
  markers = handler.addMarkers([
    { lat: 32, lng: 25},
    { lat: 22, lng: 25},
    { lat: 22, lng: 35},
    { lat: 31.75, lng: 34.05},  
  ]);
  handler.bounds.extendWith(markers);
  handler.fitMapToBounds();
  var x;
  var y;
    var url = window.location.href; 
    var urlsplit = url.split("?");
    if(urlsplit[1] != null){
      urlsplit2 = urlsplit[1].split("&");
      urlsplit3 = urlsplit2[0].split("=");
      x = urlsplit3[1];
      urlsplit4 = urlsplit2[1].split("=");
      y = urlsplit4[1];}

    else{
      x = 27;
      y = 30;
    }
  
  console.log(x);
  var json_data = [
    {
      id:  1,
      lat: x,
      lng: y,
      infowindow: "<div style='color:red;'>Your Startup</div>" //this html is properly disaplayed
    }
  ];

  //create draggable markers (pass google maps options aas a second arg)
  var markers = handler.addMarkers(json_data, { draggable: true});

  //add markers to original json
  _.each(json_data, function(json, index){
    json.marker = markers[index];
  });

  //add dragend event to markers, triggered when you drop them
  _.each(json_data, function(json){
    google.maps.event.addListener(json.marker.getServiceObject(), "dragend", function(event) {
      var lat = event.latLng.lat();
      var lng = event.latLng.lng();
     if( lat != 27 || lng != 30){
      var url = window.location.href;
      var urlsplit = url.split("?");
      url = urlsplit[0]+"?lat="+lat+"&lng="+lng;
     var urlsplit = url.split("?");
      url = urlsplit[0]+"?lat="+lat+"&lng="+lng;
     window.location.href = url;
}

      console.log('Marker with id: ' + json.id + ' dropped hat lat: ' + lat + ' and lng: ' + lng)
    });
  });
});

</script>
<!--<% @signup.update_attribute(:lat , params[:lat]) %>